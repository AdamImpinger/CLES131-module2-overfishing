---
title: "Module 2: Overfishing"
format: pdf
editor: source
editor_options: 
  chunk_output_type: console
---

```{r}
#| warning: false
library(tidyverse)
```

test!

### Use of GitHub

Link to your forked GH repository: https://github.com/AdamImpinger/CLES131-module2-overfishing#

### Use of Quarto

Link to your .qmd file:

## Overexploitation of global fisheries

We will examine the state of global fisheries and seek to reproduce one of the most widely cited examples of species collapse in order to examine the evidence behind an influential paper on global fisheries, [Worm et al. 2006](https://doi.org/10.1126/science.1132294). However, rather than using the 1950-2003 dataset available to Worm and colleagues in 2006, we will be drawing from more recent stock assessment data to see how the trends have fared, specifically in Atlantic cod.

We also explore how to understand and manipulate tabular data using relational database concepts. Instead of working with a single independent dataframe, as in Module 1, we will be working with a large relational database consisting of tables of different dimensions, but are related through one or more IDs.

## The Database

We will use data from the [RAM Legacy Stock Assessment Database](https://www.ramlegacy.org/database/). Note that the database files are available through Zenodo; please download and unzip the file, moving the .RData file only into your own `data/` folder within this project.

Use the code below to load up the tables in this database.

```{r}

load("data/DBdata[asmt][v4.66].RData")
```

The above function loads all 60 tables of this database, which is a lot! So step one of the data science process is exploring the structure of the database and figuring out how the tables are related.

A selected set of documentation have been provided in `documentation/`. Open up the Database Quickstart Guide for reference as you work through the problems below.

### Q1 (1 point)

```{r}
#unique(stock$commonname)
length(stock$commonname)
length(stock$scientificname)


#unique(stock$scientificname)
#got a different outcome then 410, your original answer, using the unique command, let me know how you approached this and double chec that
```

One of the main metadata tables is 'stock':

-   How many stocks are there and how many species do they represent?

    There are 1514 different stocks, representing 398 different species.

-   What are the top three most common stocks? (Okay to use common names; these are standardized for fish) 

The most common are the Pink Salmon, Sockeye salmon, and the Chum salmon.

-   In your own words, describe the unit of observation in the 'stock' table and some associated variables that describe it.

The unit of obersavation in the 'stock' table is a stock of fish, with each unit describing a different stock of fish in specific area. These groupings of stock fish are further described by their geographic region, country, and the state of each the stock (current, depreciated).

## 

### Q2 (1 point)

The next main metadata table is 'assessment':

-   What is the unit of observation in the 'assessment' table? How is this related to the unit of observation in the 'stock' table?

    The unit of observation for the assessment table is also stocks, but as examined over extended time periods. Assessment contextualizes the ongoing obersvation of the different stocks, providing context for when the "state" stat was most recently marked and illuminating the methodology of analysis. Some stocks are assessed more than once, resulting in multiple inputs for the same stockid, each difrentiated by time.

-   It seems like 'stockid' and 'assessyear' might uniquely identify each assessment. Is this the case? If not, why not?

No, there are repeats of assessyears meaning it can't be used as a unique identifier. Stockid however creates unique identifiers that repeat only when the same stockid is being assessed for a distinct time period, tying each examined stock to a region and specific source and time instead of tying timescales to distinct assessment's as could be achieved with assessyear.

-   Which variable(s) might you use to join 'stock' and 'assessment'?

    Stockid could be used to join stock and assessment, as it is the only overlapping unit between the two tables.

### Q3 (1 point)

In section B of the Database Quick Guide, additional metadata tables are listed in section B. With your data exploration skills, complete the following table:

| B table      | Associated table | join column from B | join column from other |
|------------------|------------------|------------------|-------------------|
| area         | stock            | areaid             | areaid                 |
| assessmethod | assessment       | methodshort        | assessmethod           |
| assessor     | strassessment    | assessorid         | assessorid             |
| management   | assessor         | mgmt               | mgmt                   |
| taxonomy     | stock            | scientificname     | scientificname         |

\*Note that assessmethod is not a data.frame, which was perhaps an oversight; consider turning it into one for the ease of using tidyverse functions.

```{r}
assessmethod <- as.data.frame(assessmethod)
```

### Q4 (1 point)

There are two main data tables described in section C, but their key attributes are difficult to understand. Join the two main data tables with their respective metrics tables (section D):

```{r}

joined.bio <- bioparams |> 
            left_join(biometrics, join_by(bioid==biounique)) |> 
            #glimpse()
 joined.time <- timeseries |> 
            left_join(tsmetrics, join_by(tsid==tsunique)) |> 
           # glimpse()

 #view was crashing my r studio, tired glimpse and head(50) to get around this, but head(50) trimmed the full data
```

-   Briefly describe the contents of each joined table.

    The joined bioparams, which are summary statistics representing the health of the stocks was combined with biometics to provide a detailed life history of each stock.

    joined.time, is similar in that it supplies more details for each stock assessments with more timeseries units.

-   What is accomplished by joining these tables?

There are multiple reasons this helps, the simpilest of those being the ability to view the unit used in the timeseries table. The "tsvalue" collumn is unitless, and when joined, there is another collumn that displays the unit. Joining these tables links analysis to the population it is describing, creating a more comprehensive picture of the stocks being analyzed and contextualizing how these stocks have changed from the time series data.

## Overexploitation of Atlantic cod

This database is clearly complex and contains a lot of information. We've grappled with its high dimensionality by exploring and joining tables above. Next, we will take a "bottom-up" approach and evaluate a single species, Atlantic cod. Read this [book chapter](https://pressbooks.pub/extinctionstories/chapter/atlantic-cod/) on Atlantic cod, which serves as a reference for the following questions.

### Q5 (1 point)

The collapse of the Atlantic cod fisheries is well documented. Let's see if we can visualize that decline with this database.

-   How many unique fish stocks comprise "Atlantic cod" and what regions do they come from?

    There are 28 fishstocks coming from four distinct regions: the east cost of Canada; Europe (non-EU); EU; and the east coast of the US

    ```{r}
    atlantic.cod.count <- stock |> 
                    filter(commonname=="Atlantic cod") |> 
                    count()

    atlantic.cod.count #28

    atlantic.cod.region <- stock |> 
                        filter(commonname=="Atlantic cod") |> 
                        select("region")
                        
    #unique(atlantic.cod.region)
    ```

Create a vector of the 'stockid' associated with "Atlantic cod". Then turn your attention to the previously-joined timeseries/tsmetrics table and create a subsetted dataframe with only observations of "Atlantic cod" that have a non-NA value. This table reports many years and many metrics, while we are primarily interested in the years since 1950.

```{r}
atlantic.stockid <- stock |> 
                    filter(commonname=="Atlantic cod") |> 
                    select("stockid")
as.vector(atlantic.stockid)

context.cod <- joined.time |> 
                    filter(str_detect(stocklong, "Atlantic cod")) |> 
  filter(tsyear >= 1950) |> 
  filter(!is.na(tsvalue))
  

view(context.cod)
                    

```

-   Which metrics are most commonly reported for Atlantic cod in this timeframe and what do they mean? in general, the most common category of data collection is total biomass. Individually, it seems like the most common metric is Tow CPUE, which is the number of fish caught per tow.

```{r}
cod_freqs <- c(context.cod$tscategory)
cod_freqs <- max(cod_freqs)
cod_freqs

cod_freqs <- c(context.cod$tslong)
cod_freqs <- max(cod_freqs)
#unique(context.cod$tslong
       )
```

### Q6 (1 point)

Make a timeseries figure for each stock of Atlantic cod. Rather than coloring by the identity of the stock, color by the region it comes from (this may require joining). Use `facet_*()` to plot both metrics in a single code chunk. Connect the points for each stock and focus on the period since 1950. Update until the figure is easily interpretable.

-   What happened to Atlantic cod stocks during the period 1950-present? What information does each metric convey?

```{r}
##28 unique stocks,
#unique(context.cod$stockid)
#28 different figures?
#unique(context.cod$stockid)

#adding region data

context.cod.region <- context.cod |> 
  left_join(stock, join_by(stocklong))

context.cod1 <- context.cod.region |> 
  filter(stockid.x == "COD4TVn") |> 
  filter(tsshort == "TB") #TB means total biomass
#enter stockname then run code below to see figure for that stock
view(context.cod1)

ggplot(context.cod1, mapping = aes(x = tsyear, y = tsvalue, color = "region")) +
      geom_line()
```

```{r}
p <- ggplot(data = context.cod.region |> 
              filter(tsshort == "TB"),
            mapping = aes(x = tsyear, y = tsvalue, color = region, group = region)) + geom_point() + geom_line () 
  
p + facet_wrap(~ stockid.x, scales = "free_y")


#this should work but is only displaying 20 /28
context.cod |> 
  filter(tsunitslong == "Individuals") |>  #can also use "TB" from tsshort
  #count(stockid)
#ahhhh but only these 20 have "TB" data,
#so it worked
```

```{r}
p + facet_wrap(~ stockid.x, scales = "free_y")
```

\`\`\` \### Q7 (1 point)

We will recreate a slightly more complex version of a figure from the [Millennium Ecosystem Assessment](https://www.millenniumassessment.org/documents/document.356.aspx.pdf) (Fig. 11).

Selecting a metric that can be added across stocks, calculate the total fish landings for each region of Atlantic cod. Make a plot similar to Fig. 11 and color by region.

Which region does Fig. 11 from the MEA correspond to?

```{r}
mod_11 <- ggplot(data = context.cod.region |> 
              filter( tsshort== "SSB"),
            mapping = aes(x = tsyear, y = tsvalue, color = region)) + 
            geom_line()+
             geom_smooth()
  mod_11

t.craft <- context.cod.region |> 
              filter( tsshort== "SSB") |> 
            view()
```

### Q8 (1 point)

Under the Management Policies section of the [book chapter](https://pressbooks.pub/extinctionstories/chapter/atlantic-cod/), the authors summarize a few major efforts to restore and protect stocks of Atlantic cod. Focusing only on the US and Canada, update your plot from above to include vertical lines to represent the timing of least three major events and label them clearly on your plot. Doing so will likely involve creating a separate dataframe and using it in one of your ggplot layers (one possible argument within `aes()` is `linetype`). Facet the plot by region and update until it is easily interpretable.

```{r}
q8_preplot <- ggplot(
  data = context.cod.region |>
    filter(
      tsshort == "SSB",
      region %in% c("Canada East Coast", "US East Coast")
    ),
  mapping = aes(x = tsyear, y = tsvalue, color = region)
) +
  geom_line() +
  geom_smooth()
q8_preplot

```

```{r}
policy.change <- c(1976,1986,1996,2006)
q8_plot <- ggplot(
  data = context.cod.region |>
    filter(
      tsshort == "SSB",
      region %in% c("Canada East Coast", "US East Coast")
    ),
  mapping = aes(x = tsyear, y = tsvalue, color = region)
)  +
  geom_smooth(se = FALSE, method = "loess", span = .1)+
geom_vline(xintercept = policy.change[1], color="darkslategrey", linetype="dashed", size=0.8 )+
geom_vline(xintercept = policy.change[2], color="darkslategrey", linetype="dashed", size=0.8 )+
geom_vline(xintercept = policy.change[3], color="darkslategrey", linetype="dashed", size=0.8 )+
geom_vline(xintercept = policy.change[4], color="darkslategrey", linetype="dashed", size=0.8 )+
labs(title = "Time Series with Major Policy Events",
       x = "Time",
       y = "Spawning Stock Biomass (in Metric Tons)")

q8_plot


```

```{r}
policy.years <- data.frame(
  year = c(1976, 1986, 1992, 1996),
  event = c("1976 Conservation Act",
    "1986 Multispecies Plan",
    "1992 Moratorium",
    "1996 Sustainable Fisheries Act")
)


q8complete_plot <- ggplot(
  data = context.cod.region |>
    filter(
      tsshort == "SSB",
      region %in% c("Canada East Coast", "US East Coast")
    ),
  mapping = aes(x = tsyear, y = tsvalue, color = region)
)  +
  geom_smooth(se = FALSE, method = "loess", span = .1)+
geom_vline(
    data = policy.years,
    aes(xintercept = year),
    inherit.aes = FALSE,
    linetype = "dashed",
    color = "darkslategrey",
    linewidth = 0.5
  ) +
  geom_text(
    data = policy.years,
    aes(x = year, y = Inf, label = event),
    angle = 285,
    inherit.aes = FALSE,
    color = "darkslategrey",
    vjust = 0.3,  
    hjust = 0,
    size = 3
  ) +
labs(title = "Time Series with Major Policy Events",
       x = "Time",
       y = "Spawning Stock Biomass (in Metric Tons)")+
  coord_cartesian(clip = "off")

q8complete_plot




```

### Q9 (2 points)

What happened to Atlantic cod stocks for each region following each piece of legislation or management plan, and why do you think this was so? Your multi-paragraph answer should be informed by content from the book chapter; additional sources are optional, and all sources should be cited.

In 1976, the Magnuson-Stevens Fishery Conservation and Management Act (MSFCMA) was passed (Public Law 94-265). This act established a structure to limit overfishing, but did not strictly enforce it. The next year, 1977, an exclusive fishing zone was implemented, requiring foreign vessels closer than 200 miles to the east coast to register for permits to fish.  Even though foreign ships were kept out, domestic fleets could continue fishing. After this act, the sharp decline in cod stocks continued, while total fish landings actually increased.This is partially because this act created regional fishery management councils, but didn’t set enough restrictions.

One decade later, in 1986, the Northeast Multispecies Fishery Management Plan was passed(New England Fishery Management Council. Northeast Multispecies Fishery Management Plan) . This act had more specific rules that aimed to protect degraded species. Among these were minimum net sizes set so that smaller fish would be able to escape trawlers, and minimum fish sizes requiring that those younger fish would be released, and be able to live and reproduce. After this point, it seems like fish landings declined sharply. Even though these limits were set and not as many fish were landed, stocks couldn’t recover quickly enough and continued to decline. 

It got to such a point of concern that in 1992 a moratorium on commercial fishing was declared (Castro, M., Rafferty, J.P. (2025, June 20). cod fishery collapse of 1992. Encyclopedia Britannica). It is hard to rebuild depleted stocks. Regardless of the 1992 moratorium’s 0 fish landings, stocks stayed low.
In 1996 (Public Law 94-265), the sustainable fisheries act was passed. This reworking of the 1976 act explicitly states how regional councils need to end overfishing and assist in rebuilding depleted stocks.
Due to continued deprecation, the act was reworked in 2006 (Public Law 94-265). This Magnuson-Stevens Fishery Conservation and Management Reauthorization Act enforced annual catch limits (ACLs). ACLs are a much more overarching form of catch limiting. With other forms like minimum fish size or net size, fishers can continue fishing and depleting stocks even if only 10% of their catch meet retention standards. With ACLs, fishers are forced to completely stop catching once they have reached their limit. 
From our data, we can see a potential effect of these ACLs. After 2010, total biomass increased dramatically.

